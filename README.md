# 画像で神経衰弱 - プロジェクトガイド

## 概要

写真や画像を使った神経衰弱（メモリーカードゲーム）アプリ。
高齢者が iPad で直感的に操作できることを最優先に設計している。
「思い出の写真」を使って遊ぶことを想定したプライバシー重視のアプリ。

## 技術構成

- **HTML / CSS / JavaScript (Vanilla JS)** のみ。フレームワークは使わない
- ファイルはメンテナンス性のため分割管理する
- サーバー不要。`index.html` をブラウザで直接開いて動作する

## ファイル構成

```
神経衰弱/
├── index.html          … メインHTML（全画面の構造を1ファイルに定義）
├── css/
│   └── style.css       … 全画面スタイル・アニメーション・レスポンシブ
├── js/
│   ├── storage.js      … IndexedDB 画像保存・ダミー画像生成・ファイル読込
│   ├── ui.js           … モーダル・サイドメニュー・サウンド効果音
│   ├── game.js         … ゲームロジック（シャッフル・マッチ判定・勝利判定）
│   └── app.js          … メインコントローラー（画面遷移・イベント管理・状態管理）
└── design/             … デザイン原案画像（参照用、コードには含めない）
```

## ターゲットデバイス

- **iPad（タブレット）** のブラウザ（Safari / Chrome）で全画面表示して使用
- 縦向き（ポートレート）を主な想定方向とする
- `viewport` に `user-scalable=no` を設定し、ピンチズームを無効化

## UI/UX 方針（高齢者向け）

- ボタン・文字・カードのサイズは **大きく** 保つ（最低タッチ領域 48px 以上）
- フォントサイズ: タイトル 2.4rem〜、ボタン 1.6rem〜、本文 1.2rem〜
- 操作は **タップのみ** でスワイプやドラッグは使わない
- 視認性のため十分なコントラストと余白を確保する
- 装飾は最小限。デザイン案のシンプルなグレー基調を維持する

## プライバシー・データ管理

- **写真データは一切サーバーに送信しない**。完全ローカル完結
- 画像保存には **IndexedDB** を使用する
- ファイル選択には `<input type="file">` と `webkitdirectory` 属性を使う
- File System Access API は将来の拡張候補として残す

## 画面遷移ルール

```
タイトル → 難易度選択 → 画像選択 → プレビュー → ゲーム → クリア
                                                  ↓         ↓
                                          (メニュー→タイトル)  → 再プレイ
                                                              → タイトルに戻る
```

### 各画面の仕様

1. **タイトル画面**
   - 「画像で神経衰弱」タイトル表示
   - 「スタート」→ 難易度選択へ
   - 「終了」→ アプリ終了（confirm あり）
   - 右上: サウンド ON/OFF トグル

2. **難易度選択画面**
   - 左右矢印で3段階を切り替え
     - ★×1 → 6枚（3ペア）
     - ★×2 → 12枚（6ペア）
     - ★×3 → 20枚（10ペア）
   - 「決定」→ 画像選択へ
   - 左上: 戻るボタン

3. **画像選択画面**
   - 「任意の画像」→ ファイル選択ダイアログ（複数画像）
   - 「アルバム」→ フォルダ選択ダイアログ
   - 画像が選ばれなかった場合 → ダミー画像を自動使用
   - 画像数が足りない場合 → ダミーで不足分を補完
   - 左上: 戻るボタン

4. **プレビュー画面**
   - 選択された画像のサムネイル一覧を表示
   - 「ゲームスタート」→ ゲーム開始
   - 左上: 戻るボタン

5. **ゲーム画面**
   - カードをグリッド配置（6枚→2列、12枚→3列、20枚→4列）
   - カードタップ → フリップアニメーション + 拡大モーダル表示
   - モーダルを閉じた後に2枚目ならマッチ判定
   - マッチ成功 → 両カード消滅（visibility: hidden + フェード）
   - マッチ失敗 → 両カード裏返し（遅延後）
   - 左上: ハンバーガーメニュー（タイトルに戻る / やり直す）
   - 全ペア完成 → クリア画面へ自動遷移

6. **クリア画面**
   - 「Congratulations!!」テキスト表示
   - 「再プレイ」→ 同じ画像で再シャッフル＆再開
   - 「タイトルに戻る」→ タイトル画面へ

### 共通 UI パーツ

- **右上**: サウンド ON/OFF アイコン（全画面共通）
- **左上**: 戻るボタン（タイトル・クリア以外） / ハンバーガーメニュー（ゲーム画面）

## ゲームロジック

- 神経衰弱（Concentration / Memory Game）の標準ルール
- 各画像は2枚ずつ（ペア）でシャッフルして配置
- 1ターンに2枚をめくる。同じ画像ならマッチ成功
- カードをめくると画像が中央に拡大表示される（モーダル）
- モーダルの×ボタンまたは背景タップで閉じる
- 2枚目のモーダルを閉じた後にマッチ判定を実行する

## サウンド

- Web Audio API で効果音を合成生成（外部音声ファイル不要）
- 効果音の種類: click / flip / match / mismatch / complete / open / close
- 右上のスピーカーアイコンで ON/OFF 切替可能
- デフォルトは ON

## ダミー画像

- Canvas API で色付き＋アルファベットラベルのカードを生成
- 実画像なしでもゲーム全体を即テスト可能
- 15色×15ラベル（A〜O）のバリエーション

## 開発上の注意点

- デザイン原案は `design/` フォルダの PNG 画像を参照すること
- 新規機能追加時はデザイン案の雰囲気（シンプル・グレー基調）を崩さない
- 外部ライブラリ・CDN は使わない。全て自前で実装する
- CSS は iPad 縦向き（768px〜）と横向き（1024px〜）のブレークポイントを設定済み

---

## 開発ログ

### 2026-01-31 実装セッション

#### 実装済み機能

1. **「任意の画像」フロー強化**
   - プレビュー画面に「◯枚中 ◯枚選択済み」カウンター表示
   - 必要枚数到達時にボタン・カウンターが緑色に変化（準備完了UI）
   - 不足時の確認モーダル「足りない分をダミー画像で補いますか？」
   - プレビュー画面で各画像に×削除ボタン（個別削除可能）
   - 「画像を追加」ボタンで追加選択対応

2. **「アルバム」機能の新規実装**
   - アルバム管理モーダル（リスト表示）
   - 新規作成: 名前入力 + 複数画像選択 → IndexedDB に永続保存
   - 既存選択: サムネイル付きリストから選択 → 必要枚数をランダム抽出してゲーム開始
   - 編集機能: アルバム名・画像の変更
   - 削除機能: 確認ダイアログ後に削除

#### 技術的決定事項

1. **IndexedDB スキーマ（バージョン2）**
   ```
   MemoryGameDB
   ├── images (従来の一時画像保存用)
   │   └── { id, data: DataURL, timestamp }
   └── albums (新規アルバム機能用)
       └── { id, name, images: DataURL[], createdAt, updatedAt }
   ```

2. **永続化リクエスト (navigator.storage.persist())**
   - 現時点では未実装。ブラウザの自動削除ポリシーに依存
   - 将来的に追加検討（特に大量画像保存時のユーザー体験向上のため）

3. **確認モーダル**
   - `UI.showConfirmModal()` が Promise を返し、ユーザー選択を await で待機
   - ボタンラベルはカスタマイズ可能（okLabel, cancelLabel）

#### 現在の課題・残タスク

- [ ] **動作テスト**: iPad 実機での動作確認（特にファイル選択ダイアログの挙動）
- [ ] **アニメーション強化**: アルバム保存成功時のフィードバック演出
- [ ] **サウンド追加**: アルバム操作時の効果音（保存成功音など）
- [ ] **データ容量表示**: IndexedDB の使用容量をユーザーに表示する機能
- [ ] **永続化リクエスト**: `navigator.storage.persist()` の実装検討
- [ ] **画像圧縮**: 大きな画像の自動リサイズ（ストレージ節約）
- [ ] **エラーハンドリング**: IndexedDB 容量不足時のユーザー向けメッセージ

#### 再開時の注意

**全体像を把握するための読み順:**

1. `CLAUDE.md` - プロジェクト仕様と本ログ
2. `js/app.js` - メインフロー（状態管理・画面遷移・イベント処理の中心）
3. `js/storage.js` - IndexedDB 操作（アルバムCRUD含む）
4. `js/ui.js` - モーダル制御（確認ダイアログ・アルバムモーダル）
5. `index.html` - 画面構造（モーダル含む）
6. `css/style.css` - UIスタイル

**重要な状態変数 (`app.js` 内):**
- `state.selectedImages` - 現在選択中の画像配列
- `state.editingAlbumId` - 編集中のアルバムID（null なら新規作成）
- `state.difficulty` - 選択中の難易度（0/1/2 → 6/12/20枚）
